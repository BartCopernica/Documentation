# JSON specification

If you set the `input-format` variable in the config file to `json`, your 
script(s) will receive JSON input from AMQPipe instead of just the message
bodies. Besides the message body, this JSON object also holds additional 
information about the consumed message. The format of this input is as follows:

````json
{
    "exchange":         "the exchange to which the message was original published",
    "routing-key":      "the routing key that was used for publishing",
    "expiration":       "string value",
    "reply-to":         "string value",
    "correlation-id":   "string value",
    "priority":         0,
    "delivery-mode":    0,
    "headers":          {},
    "content-encoding": "string value",
    "content-type":     "string value",
    "cluster-id":       "string value",
    "app-id":           "string value",
    "user-id":          "string value",
    "type-name":        "string value",
    "timestamp":        0,
    "message-id":       "string value",
    "message":          "the full message body loaded from RabbitMQ"
}
````

Most of the above properties are optional, and are only included in the
JSON if they were are available. The `message` property
holds the actual message body, and the `exchange` and `routing-key`
properties hold the name of the exchange and the routing key that
were used when the message was originally published to RabbitMQ. All
the other properties come from the envelope, and are only set
if the application that originally published the message, also set them
(most application don't use the AMQP envelope fields).

The above properties are part of the AMQP protocol. In reality, most
of these properties are not used and are left out of the envelope and
therefore also out of the JSON. However, if you're processing messages 
that were generated by an other AMQPipe instance (for example, to store
the output of a script), the 'headers' property is used to store
all sort of output.

## Headers property

When AMQPipe publishes the output of a script or program back to
RabbitMQ, it uses the 'headers' property of the envelope to store
meta information about the script. In this header, you can find
the following information:

* The hostname of the server on which the script ran
* The name of the script
* The script exit code (0 for success)
* The signal number that killed the script (if it was killed by a script)
* Any output that the script sent to stderr
* The time when the script started
* The time when the script exited

When you're writing a script that processes messages that were published
by a different AMQPipe instance, you will typically see JSON messages
like this one:

````json
{
    "headers": {
        "server":   "my.taskserver.com",
        "script":   "/path/to/myscript.php",
        "exitcode": 787,
        "signal":   11
        "errors":   "PHP Notice: undefined variable $x",
        "started":  "2015-05-01 13:12:55",
        "finished": "2015-05-01 13:12:57",
    },
    "message":  "This is the script output"
}
````

