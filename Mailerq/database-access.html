
<h1>How to effectively use the MailerQ database</h1>
<p>
    MailerQ uses a database to store statistics and configuration data.
    This is either a Mysql, PostgreSql or Sqlite database. You need
    to set up this database before you install MailerQ. The Sqlite database is
    by far the simplest to configure - all you need to do is ensure that the
    sqlite3 library is installed on your system, and that MailerQ has write
    permission for the database file.
</p>
<p>
    But the other two database systems are easy to install too.
    You only need to create the database and put the login and password in
    the MailerQ configuration file. MailerQ will do the rest and create the
    tables for you.
</p>
<p>
    MailerQ has a powerful web based MTA management console. This console
    gives you full access to statistics and configuration forms. It is thus
    not at all necessary to run any queries on the database by yourself. 
    However, if you do want to make a script or a program that retrieves 
    information from MailerQ, or that updates MailerQ's configuration, you 
    can simply do so by accessing the database directly. Every couple of
    minutes MailerQ reloads all data from its database, so the changes that
    you make to the database are automatically picked up. This does not
    require a restart.
</p>
<p>
    In this article we will explain the tables that are created by MailerQ,
    and how you can use them to retrieve information or to change the MTA's
    configuration.
</p>
<h2>Database structure</h2>
<p>
    Because MailerQ is compatible with many different database
    systems, we do not use obscure or vendor specific features. All
    tables are simple and straightforward. There are no foreign 
    keys or constraints on the tables. Booleans are stored as integers
    and NULL and 0 values have the same semantics. The value -1 is used
    to set something to 'unlimited'.
</p>
<ul>
    <li><a href="documentation/database-access#capacity" title="capacity">capacity</a></li>
    <li><a href="documentation/database-access#capacity" title="capacity per IP"> capacity_per_ip</a></li>
    <li><a href="documentation/database-access#deliveries" title="deliveries domain"> deliveries_domain</a></li>
    <li><a href="documentation/database-access#deliveries" title="deliveries IP"> deliveries_ip</a></li>
    <li><a href="documentation/database-access#deliveries" title="deliveries total"> deliveries_total<a/></li>
    <li><a href="documentation/database-access#dkimKeys" title="DKIM keys"> dkim_keys</a></li>
</ul>
<h3 id="capacity">Tables 'capacity' and 'capacity_per_ip'</h3>
<p>
    The 'capacity' and 'capacity_per_ip' tables hold the delivery capacities 
    per target domain. If you want to install different limits for your local
    outgoing IP addresses you can use the 'capacity_per_ip' table. 
    The 'capacity' table holds the records for system wide delivery capacities 
    per domain - no matter what local IP is used.
</p>
<p>
    When MailerQ sends out an email from one of its own IP addresses, it will 
    first check if a record exists in the 'capacity_per_ip' table by running 
    a select query with the domain name and local IP address in the where 
    clause. If there was no matching record in this table, it will run a
    subsequent query on the 'capacity' table with only the domain
    name in the where clause.
</p>
<table class="mailerq">
    <tr>
        <th class="fieldNameTh">field name</th>
        <th class="fieldTypeTh">type</th>
        <th class="fieldDescTh">description</th>
    </tr>
    <tr>
        <td>id</td>
        <td>int PRIMARY_KEY</td>
        <td>
            The unique ID for the record
        </td>
    </tr>
    <tr class="odd">
        <td>domain</td>
        <td>varchar UNIQUE</td>
        <td>
            A domain name for which capacity settings are defined
        </td>
    </tr>
    <tr>
        <td>version</td>
        <td>tinyint</td>
        <td>
            This column is only available in the 'capacity_per_ip' table
            and holds the IP address version. Supported values are 4 for 
            IPv4 and 6 for IPv6.
        </td>
    </tr>
    <tr class="odd">
        <td>localip</td>
        <td>binary(16)</td>
        <td>
            This column is only available in the 'capacity_per_ip' table
            and holds the local IP address for which the row hold delivery
            capacities. The IP address is stored in 
            <a href="database-access#ips" title="binary format" >binary format</a>.
        </td>
    </tr>
    <tr>
        <td>domain_maxmessages</td>
        <td>int DEFAULT -1</td>
        <td>
            Max number of messages per minute that are sent to the domain
        </td>
    </tr>
    <tr class="odd">
        <td>domain_maxconnects</td>
        <td>int DEFAULT -1</td>
        <td>
            Max number of newly created connections per minute for this domain
        </td>
    </tr>
    <tr>
        <td>domain_maxconnections</td>
        <td>int DEFAULT -1</td>
        <td>
            Max number of connections that can be open at the same time to 
            the domain
        </td>
    </tr>
    <tr class="odd">
        <td>ip_maxmessages</td>
        <td>int DEFAULT -1</td>
        <td>
            Max number of messages per minute that are sent to the IP addresses 
            linked to the domain
        </td>
    </tr>
    <tr>
        <td>ip_maxconnects</td>
        <td>int DEFAULT -1</td>
        <td>
            Max number of newly created connections per minute to the IP 
            addresses linked to the domain
        </td>
    </tr>
    <tr class="odd">
        <td>ip_maxconnections</td>
        <td>int DEFAULT -1</td>
        <td>
            Max number of connections that can be open at the same time to 
            an IP address the domain
        </td>
    </tr>
    <tr>
        <td>connection_maxmessages</td>
        <td>int DEFAULT -1</td>
        <td>
            Max number of emails to send over an opened connection before 
            it is closed
        </td>
    </tr>
    <tr class="odd">
        <td>connection_maxidletime</td>
        <td>int DEFAULT -1</td>
        <td>
            Max number of miliseconds a connection is kept idle. MailerQ
            can keep connections open while it is throttling the deliveries.
            A connection is however never kept open for a longer period
            than this limit.
        </td>
    </tr>
    <tr>
        <td>secure</td>
        <td>int</td>
        <td>
            Boolean type field. Defines if secure connection should be 
            attempted. If secure connections are not supported by the
            receiving server, regular connections are established.
        </td>
    </tr>
</table>
<h4>Examples</h4>
<p>
    Limit the number of message deliveries to example.org to 1000 messages
    per minute and make sure that there will never be more than 2 connections
    open at the same time:
</p>
<div class="codeBox">
    <pre><code>insert into capacity (domain, domain_maxmessages, domain_maxconnections) values ('example.org', 1000, 2)</code></pre>
</div>
<p>
    Imagine that the example.org has four different IP addresses on which
    it receives email, and you do not want MailerQ to make more than five
    new connections per minute to each of those servers (thus 4 x 5 = 20
    new connections in total):
</p>
<div class="codeBox">
    <pre><code>update capacity set ip_maxconnects = 5 where domain = 'example.org'</code></pre>
</div>
<h3 id="deliveries">Tables 'deliveries_domain', 'deliveries_ip' and 'deliveries_total'</h3>
<p>
    The three tables that all start with the name 'deliveries' are filled by
    MailerQ with counters with the number of deliveries, failures and retries.
    The data in the tables is used by the management console to display
    charts. In normal situations there is no good reason to insert or update 
    any data in these tables, but you could run queries to remove rows from 
    the table or to retrieve data if you want to display statistics somewhere 
    else.
</p>
<p>
    Although it would have been perfectly possible to integrate the three
    capacity tables into one single table, we use three different tables
    to speed up the queries used by the charts on the management 
    console. The tables contain the total number of deliveries, the deliveries
    split up per target domain and the deliveries per ip:
</p>
<p>
    <ul>
        <li>Table 'deliveries_total': counters per minute for all deliveries</li>
        <li>Table 'deliveries_domain': counters per minute split up per domain</li>
        <li>Table 'deliveries_ip': counters per minute splut up per remote target ip</li>
    </ul>
</p>
<table class="mailerq">
    <tr>
        <th class="fieldNameTh">field name</th>
        <th class="fieldTypeTh">type</th>
        <th class="fieldDescTh">description</th>
    </tr>
    <tr class="odd">
        <td>id</td>
        <td>int PRIMARY_KEY</td>
        <td>Usual auto_increment id field</td>
    </tr>
    <tr>
        <td>time</td>
        <td>datetime</td>
        <td>
            The minute for which the row holds the counters. Because all
            counters are kept per minute, only timestamps with rounded
            seconds (set to 00) are stored in this field.
        </td>
    </tr>
    <tr class="odd">
        <td>version</td>
        <td>tinyint</td>
        <td>
            IP address version. 4 for IPv4 and 6 for IPv6.
        </td>
    </tr>
    <tr>
        <td>localip</td>
        <td>binary(16)</td>
        <td>
            IP address from which messages were sent. This column contains
            <a href="database-access#ips" title="binary data" >binary data</a>.
        </td>
    </tr>
    <tr class="odd">
        <td>domain</td>
        <td>varchar</td>
        <td>
            This column is only available in the table 'deliveries_domain'
            and holds the domain to which the messages were sent.
        </td>
    </tr>
    <tr>
        <td>remoteip</td>
        <td>binary(16)</td>
        <td>
            This column is only available in the table 'deliveries_ip'
            and holds the IP address to which the messages were sent. The
            IP address is stored in <a href="database-access#ips" title="binary format">binary 
            format</a>.
        </td>
    </tr>
    <tr class="odd">
        <td>success</td>
        <td>int</td>
        <td>Number of successful deliveries</td>
    </tr>
    <tr>
        <td>failures</td>
        <td>int</td>
        <td>Number of failed deliveries</td>
    </tr>
    <tr class="odd">
        <td>retries</td>
        <td>int</td>
        <td>Number of retries</td>
    </tr>
</table>
<br/>
<p>
    Data in this table is used to generate statistics. Since the data is never 
    deleted it can grow significantly pretty quick. Data can be safely removed 
    without any other problems than loss of statistic information.
</p>
<h3 id="dkimKeys">Table 'dkim_keys'</h3>
<p>
    The last table to discuss is the 'dkim_keys' table. This holds all DKIM
    keys that are used by MailerQ for signing the outgoing messages. Each
    record holds a domain name, DKIM selector, the algorithm to use
    and of course the private key. MailerQ reloads all DKIM keys every 10
    minutes so it is advised to wait at least 10 minutes before you send
    out an email if you have just updated the database. DKIM keys stored
    via the management console are immediately active.
</p>
<table class="mailerq">
    <tr>
        <th class="fieldNameTh">field name</th>
        <th class="fieldTypeTh">type</th>
        <th class="fieldDescTh">description</th>
    </tr>
    <tr>
        <td>id</td>
        <td>int PRIMARY_KEY</td>
        <td>Usual auto_increment id field</td>
    </tr>
    <tr class="odd">
        <td>domain</td>
        <td>varchar UNIQUE</td>
        <td>
            The domain for which this record holds the DKIM key. 
            Must be lower case.
        </td>
    </tr>
    <tr>
        <td>selector</td>
        <td>varchar</td>
        <td>The selector for DKIM signing.</td></tr>
    <tr class="odd"><td>privatekey</td><td>mediumtext</td><td>Private key used for encryption. It should be kept secret at all times.</td></tr>
    <tr><td>algorithm</td><td>varchar</td><td>An algorithm used for data encryption ( accepts SHA-1 or SHA-256 )</td></tr>
</table>
<br/>
<h2 class="ips">Ip addresses in binary format</h2>
<p>
    MailerQ stores IP addresses in binary format. An IPv6 address takes up
    16 bytes, and an IPv4 address takes up 4 bytes and is stuffed with an 
    additional 12 zero bytes to fill up the 16 bytes that
    are reserved for IP addresses.
</p>
<p>
    In PHP you can use the functions inet_ntop() and inet_pton() to convert 
    IP addresses to and from binary format:
</p>
<div class="codeBox"><pre class="language-php"><code class="language-php">
$binary4 = inet_pton($ipv4).pack("LLL",0,0,0);
$binary6 = inet_pton($ipv6);
$ipv4 = inet_ntop($binary4);
$ipv6 = inet_ntop($binary6);</code></pre></div>
